<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <title>Foto + Lokasi + EXIF</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 15px;
      background: #f5f5f5;
    }
    #video, #photoPreview {
      width: 100%;
      max-width: 500px;
      height: auto;
      background: #000;
      border-radius: 8px;
      margin: 10px auto;
    }
    #video {
      transform: scaleX(-1);
    }
    #photoPreview {
      display: none;
      border: 2px solid #4CAF50;
    }
    .btn {
      margin: 6px;
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .primary { background: #2196F3; color: white; }
    .success { background: #4CAF50; color: white; }
    .controls { margin: 15px 0; }
    #status {
      margin: 10px 0;
      color: #555;
      font-size: 14px;
      min-height: 20px;
    }
    .info {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>üì∏ ABSEN LOKASI</h2>

  <div id="locationStatus" class="info">üìç Lokasi: Menunggu izin...</div>
  <div id="map" style="width: 100%; max-width: 500px; height: 250px; margin: 15px auto; border-radius: 8px; display: none;"></div>
  
  <div id="status">Meminta akses kamera...</div>
  <video id="video" autoplay muted playsinline></video>
  <img id="photoPreview" alt="Hasil Foto">

  <div class="controls">
    <button id="switchBtn" class="btn primary" disabled>üîÑ Ganti Kamera</button>
    <br>
    <button id="captureBtn" class="btn success">üì∑ Ambil Foto</button>
    <button id="downloadBtn" class="btn success" style="display:none;">‚¨áÔ∏è Unduh</button>
    <button id="retakeBtn" class="btn" style="display:none;">‚Ü∫ Ambil Ulang</button>
  </div>


  <!-- Library piexifjs -->
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const photoPreview = document.getElementById('photoPreview');
    const switchBtn = document.getElementById('switchBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const statusEl = document.getElementById('status');
    const locationStatusEl = document.getElementById('locationStatus');

    let stream = null;
    let userLocation = null;
    let capturedImageUrl = null;
    let facingMode = 'environment';
    let map = null;
    let marker = null;

    function initMap(lat, lng) {
      const mapContainer = document.getElementById('map');
      mapContainer.style.display = 'block';

      if (map) map.remove();

      map = L.map('map').setView([lat, lng], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup('Lokasi Anda')
        .openPopup();
    }

    // === Konversi ke format EXIF ===
    function toExifRational(value) {
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const min = Math.floor((abs - deg) * 60);
      const sec = (abs - deg - min / 60) * 3600;
      return [[deg, 1], [min, 1], [Math.round(sec * 10000), 10000]];
    }

    // === Dapatkan lokasi ===
    async function requestLocation() {
      if (!navigator.geolocation) {
        locationStatusEl.textContent = "‚ùå Geolocation tidak didukung";
        return null;
      }

      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000
          });
        });

        userLocation = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        initMap(userLocation.lat, userLocation.lng);
        
        locationStatusEl.textContent = `‚úÖ Lokasi: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
        return userLocation;

      } catch (err) {
        userLocation = null;
        locationStatusEl.textContent = "‚ö†Ô∏è Lokasi tidak diizinkan atau tidak tersedia";
        document.getElementById('map').style.display = 'none';
        console.warn("Geolocation error:", err);
        return null;
      }
    }

    // === Mulai kamera ===
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode }, 
          audio: false 
        });
        video.srcObject = stream;
        statusEl.textContent = `Kamera aktif (${facingMode === 'user' ? 'Depan' : 'Belakang'})`;
      } catch (err) {
        statusEl.textContent = "‚ùå Gagal akses kamera: " + err.message;
        console.error(err);
      }
    }

    // === Ganti kamera ===
    // switchBtn.addEventListener('click', () => {
    //   facingMode = facingMode === 'user' ? 'environment' : 'user';
    //   startCamera();
    // });

    // === Ganti kamera (depan/belakang) ===
    switchBtn.addEventListener('click', async () => {
      if (!stream) return;

      // Hentikan stream lama
      stream.getTracks().forEach(track => track.stop());

      // Toggle facingMode
      facingMode = facingMode === 'user' ? 'environment' : 'user';

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });

        video.srcObject = stream;
        statusEl.textContent = `Kamera aktif (${facingMode === 'user' ? 'Depan' : 'Belakang'})`;

        // Optional: log deviceId
        const tracks = stream.getVideoTracks();
        if (tracks[0]?.getSettings) {
          const settings = tracks[0].getSettings();
          console.log("Device ID:", settings.deviceId);
        }

      } catch (err) {
        statusEl.textContent = "‚ùå Gagal ganti kamera: " + err.message;
        console.error(err);
      }
    });

    // === Ambil foto ===
    captureBtn.addEventListener('click', async () => {
      // Pastikan lokasi sudah diminta
      if (!userLocation) {
        await requestLocation(); // Coba lagi
      }

      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      // Gambar frame asli (tanpa mirror!)
      ctx.drawImage(video, 0, 0, w, h);

      // === Format waktu ===
      const now = new Date();
      const timestamp = now.toLocaleString('id-ID', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });

      // Atur font untuk pengukuran
      ctx.font = '16px Arial';
      ctx.textBaseline = 'top';

      // Buat teks waktu
      const timestampText = `Waktu: ${timestamp}`;
      let locText = '';
      let hasLocation = false;

      if (userLocation) {
        locText = `Lokasi: ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
        hasLocation = true;
      } else {
        locText = "Lokasi: Tidak tersedia";
      }

      // Hitung lebar teks
      const timestampWidth = ctx.measureText(timestampText).width;
      const locWidth = ctx.measureText(locText).width;
      const boxWidth = Math.max(timestampWidth, locWidth) + 20;
      const boxHeight = hasLocation ? 60 : 35;

      // Gambar kotak hitam transparan
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(10, 10, boxWidth, boxHeight);

      // ‚úÖ PENTING: Set warna teks PUTIH
      ctx.fillStyle = 'white';

      // Gambar teks waktu
      ctx.fillText(timestampText, 20, 15);

      // Gambar teks lokasi (jika ada)
      if (hasLocation) {
        ctx.fillText(locText, 20, 40);
      } else {
        // Tampilkan pesan "Lokasi tidak tersedia"
        ctx.fillText(locText, 20, 40);
      }

      // === Simpan sebagai JPEG ===
      let dataURL = canvas.toDataURL('image/jpeg', 0.92);

      // === Tambahkan EXIF ===
      if (piexif) {
        try {
          let exifObj = piexif.load(dataURL);

          // Tambahkan DateTime
          const exifDateTime = now.toISOString().replace(/-/g, ':').substring(0, 19).replace('T', ' ');
          exifObj["0th"][piexif.ImageIFD.DateTime] = exifDateTime;
          exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = exifDateTime;
          exifObj["Exif"][piexif.ExifIFD.DateTimeDigitized] = exifDateTime;

          // Tambahkan GPS hanya jika userLocation ada
          if (userLocation) {
            exifObj["GPS"][piexif.GPSIFD.GPSLatitudeRef] = userLocation.lat >= 0 ? "N" : "S";
            exifObj["GPS"][piexif.GPSIFD.GPSLatitude] = toExifRational(userLocation.lat);
            exifObj["GPS"][piexif.GPSIFD.GPSLongitudeRef] = userLocation.lng >= 0 ? "E" : "W";
            exifObj["GPS"][piexif.GPSIFD.GPSLongitude] = toExifRational(userLocation.lng);
          }

          // Sisipkan EXIF
          const exifStr = piexif.dump(exifObj);
          dataURL = piexif.insert(exifStr, dataURL);
        } catch (e) {
          console.error("Gagal tambah EXIF:", e);
        }
      }

      // Simpan & tampilkan preview
      capturedImageUrl = dataURL;
      photoPreview.src = capturedImageUrl;
      photoPreview.style.display = 'block';

      // Tampilkan tombol
      downloadBtn.style.display = 'inline-block';
      retakeBtn.style.display = 'inline-block';
      captureBtn.style.display = 'none';
      switchBtn.disabled = true;
      statusEl.textContent = "‚úÖ Foto siap diunduh!";
    });

    // === Unduh ===
    downloadBtn.addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = capturedImageUrl;
      a.download = `foto-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.jpg`;
      a.click();
    });

    // === Ambil ulang ===
    retakeBtn.addEventListener('click', () => {
      photoPreview.style.display = 'none';
      downloadBtn.style.display = 'none';
      retakeBtn.style.display = 'none';
      captureBtn.style.display = 'inline-block';
      switchBtn.disabled = false;
      statusEl.textContent = "Siap ambil foto lagi";
    });

    // === Inisialisasi ===
    (async () => {
      await startCamera();
      await requestLocation();

      // Aktifkan tombol ganti kamera
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      switchBtn.disabled = cams.length <= 1;

      if (!stream) {
        statusEl.textContent = "‚ùå Kamera tidak tersedia";
      }
    })();

    // === Kirim data absensi ke Google Sheets ===
    async function submitAbsensi(lat, lng, userId = 'user-' + Date.now()) {
      const WEB_APP_URL = 'https://script.google.com/macros/s/ABC123/exec'; // ‚Üê GANTI DENGAN URL-MU

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: userId,
            lat: lat,
            lng: lng,
            status: 'Hadir'
          })
        });

        const result = await response.json();
        return result.success;
      } catch (err) {
        console.error('Gagal kirim absensi:', err);
        return false;
      }
    }
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
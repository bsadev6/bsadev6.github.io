<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <title>Absensi Karyawan</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 15px;
      background: #f5f5f5;
    }
    #video, #photoPreview {
      width: 100%;
      max-width: 500px;
      height: auto;
      background: #000;
      border-radius: 8px;
      margin: 10px auto;
      transform: scaleX(-1);
    }
    #photoPreview {
      display: none;
      transform: none;
      border: 2px solid #4CAF50;
    }
    #map {
      width: 100%;
      max-width: 500px;
      height: 150px;
      margin: 15px auto;
      border-radius: 8px;
      display: none;
      border: 1px solid #ccc;
    }
    .input-group {
      margin: 15px 0;
    }
    input {
      padding: 12px;
      font-size: 16px;
      width: 80%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .btn {
      margin: 6px;
      padding: 12px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .primary { background: #007AFF; color: white; }
    .success { background: #34C759; color: white; }
    .controls { margin: 15px 0; }
    #status {
      margin: 10px 0;
      color: #555;
      font-size: 14px;
      min-height: 20px;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <h2>üìã Absensi Karyawan V3</h2>

  <!-- Nav Tabs -->
    <ul class="nav nav-tabs" id="absensiTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="absensi-tab" data-bs-toggle="tab" data-bs-target="#absensi" type="button" role="tab">
          <i class="fas fa-camera me-1"></i> Absensi
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="histori-tab" data-bs-toggle="tab" data-bs-target="#histori" type="button" role="tab">
          <i class="fas fa-history me-1"></i> Riwayat Absen
        </button>
      </li>
    </ul>
     <!-- Tab Content -->
    <div class="tab-content card p-4 mt-3" id="absensiTabContent">
      
      <!-- Tab Absensi -->
      <div class="tab-pane fade show active" id="absensi" role="tabpanel">
            <div class="row justify-content-center">
            <div class="col-sm-3">
              <div class="card">
                <div class="card-body">
                  <div id="status">Masukkan ID & klik "Login"</div>
                  <div class="row justify-content-center">
                    <div class="col-sm-12">
                      <input type="text" id="userIdInput" placeholder="Masukkan ID Karyawan" autocomplete="off">
                      <button id="startAppBtn" class="btn primary">‚ñ∂Ô∏è Login</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <br>
          <div class="row justify-content-center">
            <div class="col-sm-3">
                <div class="card">
                    <div class="card-body">
            
                      <div class="row justify-content-center">
                        <div class="col-sm-12">
                          <!-- Tombol mulai -->
                        
                          <div id="namaKaryawan" class="info"></div>
                          <div id="locationStatus" class="info"></div>
                          <div id="map"></div>
                          <video 
                            id="video" 
                            autoplay 
                            muted 
                            playsinline 
                            webkit-playsinline
                            style="display:none;"
                          ></video>
                        </div>
            
                      </div>
                      
                    </div>
                </div>
            </div>
          </div>
          <br>
          <div class="row justify-content-center">
            <div class="col-sm-3">
                <div class="card">
                    <div class="card-body">
                        <img id="photoPreview" alt="Foto Absensi">

                        <div class="controls">
                          <button id="switchBtn" class="btn btn-primary" style="display:none;">üîÑ Ganti Kamera</button>
                          <button id="captureBtn" class="btn btn-success" style="display:none;">üì∑ Ambil Foto</button>
                          <button id="downloadBtn" class="btn btn-success" style="display:none;">‚¨áÔ∏è Unduh</button>
                          <button id="retakeBtn" class="btn btn-warning" style="display:none;">‚Ü∫ Ambil Ulang</button>
                          <button id="sendBtn" class="btn btn-primary" style="display:none;">üì§ Kirim ke Server</button>
                          <div id="statuSend" ></div>
                        </div>
                    </div>
                </div>
            </div>
          </div>
      </div>

      <!-- Tab Histori -->
      <div class="tab-pane fade" id="histori" role="tabpanel">
          <h4 class="mb-3">üìú Riwayat Absen</h4>
          <div class="row mb-3">
              
              <div class="col-md-2">
                <select id="filterBulan" class="form-select mb-3" placeholder="Pilih Bulan">
                  <option value="">Semua Bulan</option>
                  <option value="1">Januari</option>
                  <option value="2">Februari</option>
                  <option value="3">Maret</option>
                  <option value="4">April</option>
                  <option value="5">Mei</option>
                  <option value="6">Juni</option>
                  <option value="7">Juli</option>
                  <option value="8">Agustus</option>
                  <option value="9">September</option>
                  <option value="10">Oktober</option>
                  <option value="11">November</option>
                  <option value="12">Desember</option>
                </select>
              </div>
              <div class="col-md-2">
                <select id="filterTahun" class="form-select mb-3" placeholder="Pilih Tahun">
                  <option value="">Semua Tahun</option>
                  <!-- Tahun akan diisi otomatis oleh JS -->
                </select>
              </div>
              <div class="col-md-3">
                <button id="btnFilter" class="btn btn-primary w-100" onclick="loadHistori(1)">
                  <i class="fas fa-search"></i> Filter
                </button>
              </div>
          </div>
          <br>
          <div id="loading" class="text-center">Memuat data...</div>
          <div class="table-responsive">
              <table class="table table-borderless table-striped" id="historiTable" style="display:none;">
                <thead class="table-light">
                  <tr>
                    <th>Tanggal</th>
                    <th>Clock In</th>
                    <th>Clock Out</th>
                  </tr>
                </thead>
                <tbody id="historiBody">
                  <!-- Data akan diisi via JavaScript -->
                </tbody>
              </table>
          </div>
          <!-- Pagination -->
         <nav aria-label="Pagination" id="paginationNav" style="display:none;">
           <ul class="pagination justify-content-center" id="paginationList">
             <!-- Dinamis diisi oleh JS -->
           </ul>
         </nav>
   
         <div id="noData" class="text-center d-none">
           <p class="text-muted">Tidak ada data absen.</p>
         </div>
      </div>
    </div>
  
  


  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

  <script>
    // === Elemen DOM ===
    const SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSXtPzMDcaFd4wkv58hcPuRJ575PYfn3YP8lgdJW0-plTUkwFzYi9ETU9tAo_izIztDHT376d2oIxRE/pub?output=csv';
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxo6z7fnW-bqZxgRHt1bVBvf1envqUNZm1hqKJc6w3AI3PQ8gS1PMG_sqA7asTNmCGC/exec";
    
    const video = document.getElementById('video');
    const photoPreview = document.getElementById('photoPreview');
    const mapEl = document.getElementById('map');
    const userIdInput = document.getElementById('userIdInput');
    const startAppBtn = document.getElementById('startAppBtn');
    const switchBtn = document.getElementById('switchBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const statusEl = document.getElementById('status');
    const sendBtn =  document.getElementById('sendBtn');
    const statuSend = document.getElementById('statuSend');
    const locationStatusEl = document.getElementById('locationStatus');
    const namaKaryawan = document.getElementById('namaKaryawan');
    
    // === Variabel Global ===
    let nama='';
    let timestampSet='';
    let formData = new FormData();
    let stream = null;
    let userLocation = null;
    let capturedImageUrl = null;
    let facingMode = 'user'; // 'user' atau 'environment'
    let map = null;

    // Format tanggal dari "20/10/2025, 10.12.45" jadi "20 Okt 2025 10:12:45"
    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      const [datePart, timePart] = dateStr.split(', ');
      const [day, month, year] = datePart.split('/');
      const [hour, min, sec] = timePart.split('.');
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      
      // ${hour}:${min}:${sec} ${year}
      return `${day} ${months[parseInt(month)-1]}`;
    }

    function extractTimeFromDateTime(dateTimeStr) {
      // Contoh input: "20/10/2025, 10.12.45"
      if (!dateTimeStr || !dateTimeStr.includes(', ')) {
        return null;
      }

      // Ambil bagian waktu setelah koma
      const timePart = dateTimeStr.split(', ')[1]; // ‚Üí "10.12.45"

      if (!timePart || !timePart.includes('.')) {
        return null;
      }

      // Pisahkan jam, menit, detik
      const [hours, minutes, seconds] = timePart.split('.');

      // Validasi
      if (!hours || !minutes || !seconds) {
        return null;
      }

      return {
        hours: parseInt(hours, 10),
        minutes: parseInt(minutes, 10),
        seconds: parseInt(seconds, 10),
        // Format sebagai string HH:mm:ss
        formatted: `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`
      };
    }

    
    /**
     * Transformasi data absensi dengan filter yang tahan terhadap string/number
     */
    function transformAbsensiDataWithFilter(rawData, filterId = '', filterBulan = null, filterTahun = null) {
      const grouped = {};
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

      // Normalisasi filter ke string (karena data sheet berupa string)
      const normalizedFilterBulan = filterBulan !== null ? String(filterBulan).padStart(2, '0') : null;
      const normalizedFilterTahun = filterTahun !== null ? String(filterTahun) : null;

      rawData.forEach(row => {
        const id = String(row.id || '').trim();
        const dateString = String(row.date || '').trim();

        if (!dateString || !id) return;
        if (!dateString.includes(', ')) return;

        const [datePart] = dateString.split(', '); // hanya butuh bagian tanggal
        const dateParts = datePart.split('/');
        if (dateParts.length !== 3) return;

        const [dayStr, monthStr, yearStr] = dateParts.map(s => s.trim());

        // Validasi dasar
        if (!dayStr || !monthStr || !yearStr) return;

        // üîç FILTER: ID
        if (filterId && id !== filterId) return;

        // üîç FILTER: Bulan (bandingkan sebagai string 2-digit)
        if (normalizedFilterBulan && monthStr.padStart(2, '0') !== normalizedFilterBulan) return;

        // üîç FILTER: Tahun (bandingkan sebagai string)
        if (normalizedFilterTahun && yearStr !== normalizedFilterTahun) return;

        // Lanjutkan proses...
        const displayDate = `${dayStr} ${months[parseInt(monthStr, 10) - 1]}`;
        const key = `${id}-${displayDate}`;

        if (!grouped[key]) {
          grouped[key] = {
            id: id,
            date: displayDate,
            clockIn: null,
            clockOut: null,
            rawTimes: []
          };
        }

        // Parse waktu
        const timePart = dateString.split(', ')[1];
        if (!timePart) return;

        const timeParts = timePart.split('.');
        if (timeParts.length !== 3) return;

        const [h, m, s] = timeParts.map(t => t.trim().padStart(2, '0'));
        const timeStr = `${h}:${m}:${s}`;
        const timeInSeconds = parseInt(h, 10) * 3600 + parseInt(m, 10) * 60 + parseInt(s, 10);

        grouped[key].rawTimes.push({ timeStr, timeInSeconds });

        if (!grouped[key].clockIn || timeInSeconds < grouped[key].clockIn.timeInSeconds) {
          grouped[key].clockIn = { timeStr, timeInSeconds };
        }
        if (!grouped[key].clockOut || timeInSeconds > grouped[key].clockOut.timeInSeconds) {
          grouped[key].clockOut = { timeStr, timeInSeconds };
        }
      });

      return Object.values(grouped).map(item => ({
        id: item.id,
        date: item.date,
        clockIn: item.clockIn ? item.clockIn.timeStr : '-',
        clockOut: item.clockOut ? item.clockOut.timeStr : '-'
      }));
    }    
    
    
    async function login() {
      const id = document.getElementById('userIdInput').value.trim();
      
      try {
        const response = await fetch(SHEET_CSV_URL);
        // const response = await fetch(PROXIED_URL);
        const csv = await response.text();
        const lines = csv.split('\n').slice(1); // skip header

        let found = false;
        for (const line of lines) {
          if (!line.trim()) continue;
          const cols = line.split(',');
          const sheetId = cols[0]?.trim(); // kolom pertama = ID
          nama = cols[1]?.trim(); // kolom kedua = Nama
          if (sheetId === id) {
            found = true;
            break;
          }
        }

        if (found) {
         
          alert(`‚úÖ Login berhasil,Selamat Datang: ${id}-${nama}`);
          // Redirect atau lanjut ke halaman absen
          // startAppBtn.style.display = 'none';
          switchBtn.style.display = 'inline-block';
          captureBtn.style.display = 'inline-block';
          namaKaryawan.innerHTML = `<strong>üë§ Karyawan: ${nama} (ID: ${id})</strong>`;
          await requestLocation();
          // await startCamera();

          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d => d.kind === 'videoinput');
          switchBtn.disabled = cams.length <= 1;
        } else {
         
          switchBtn.style.display = 'none';
          captureBtn.style.display = 'none';
          alert('ID tidak ditemukan!');
        }
      } catch (e) {
        // msg.className = 'error';
        // msg.textContent = 'Gagal memuat data. Pastikan sheet dipublikasikan.';
        alert('Gagal memuat data.'+e);
        console.error(e);
      }
    }

    // === Helper: Konversi EXIF ===
    function toExifRational(value) {
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const min = Math.floor((abs - deg) * 60);
      const sec = (abs - deg - min / 60) * 3600;
      return [[deg, 1], [min, 1], [Math.round(sec * 10000), 10000]];
    }

    // === Peta ===
    function initMap(lat, lng) {
      mapEl.style.display = 'block';
      if (map) map.remove();
      map = L.map('map').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      L.marker([lat, lng]).addTo(map).bindPopup('Lokasi Absensi').openPopup();

      startCamera();
    }

    // === Lokasi ===
    async function requestLocation() {
      
      if (!navigator.geolocation) {
        statusEl.textContent = "Geolocation tidak didukung";
        return null;
      }
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000
          });
        });
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        locationStatusEl.style.display='block';
        locationStatusEl.textContent = `‚úÖ Lokasi: ${userLocation.lat}, ${userLocation.lng}`;
        initMap(userLocation.lat, userLocation.lng);
        return userLocation;
      } catch (err) {
        userLocation = null;
        statusEl.textContent = "Lokasi tidak diizinkan";
        mapEl.style.display = 'none';
        return null;
      }
    }

    // === Kamera ===
    async function startCamera() {

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });
        video.srcObject = stream;
        video.style.display = 'block';
        captureBtn.disabled = false;
        statusEl.textContent = `Kamera aktif (${facingMode === 'user' ? 'Depan' : 'Belakang'})`;
      } catch (err) {
        statusEl.textContent = "Gagal akses kamera";
        console.error(err);
      }
    }

    // === Ganti Kamera ===
    switchBtn.addEventListener('click', async () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
      facingMode = facingMode === 'user' ? 'environment' : 'user';
      await startCamera();
    });

    captureBtn.addEventListener('click', async () => {
      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("Harap masukkan ID Karyawan!");
        return;
      }

      if (!userLocation) await requestLocation();

      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      // === GAMBAR VIDEO TANPA MIRROR (FLIP HORIZONTAL) ===
      ctx.save();
      ctx.translate(w, 0);      // Pindahkan origin ke kanan
      ctx.scale(-1, 1);         // Balik sumbu X (mirror horizontal)
      ctx.drawImage(video, 0, 0, w, h); // Gambar video dalam keadaan terbalik ‚Üí hasilnya normal
      ctx.restore();            // Kembalikan transformasi agar teks tidak ikut terbalik

      // === TAMBAHKAN TEKS INFORMASI ===
      const now = new Date();
      const timestamp = now.toLocaleString('id-ID', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });

      timestampSet=timestamp;

      ctx.font = '16px Arial';
      ctx.textBaseline = 'top';

      const timestampText = `Waktu: ${timestamp}`;
      const locText = userLocation ? 
        `Lokasi: ${userLocation.lat}, ${userLocation.lng}` : 
        "Lokasi: Tidak tersedia";
      const idText = `ID: ${userId}-${nama}`;

      const tw = ctx.measureText(timestampText).width;
      const lw = ctx.measureText(locText).width;
      const iw = ctx.measureText(idText).width;
      const boxW = Math.max(tw, lw, iw) + 20;
      const boxH = userLocation ? 75 : 60;

      // Kotak latar belakang transparan
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(10, 10, boxW, boxH);

      // Teks putih di atas kotak
      ctx.fillStyle = 'white';
      ctx.fillText(timestampText, 20, 15);
      ctx.fillText(idText, 20, 35);
      if (userLocation) ctx.fillText(locText, 20, 55);

      // === SIMPAN SEBAGAI JPEG DENGAN EXIF (JIKA ADA LOKASI) ===
      let dataURL = canvas.toDataURL('image/jpeg', 0.92);

      if (piexif && userLocation) {
        try {
          let exifObj = piexif.load(dataURL);
          const exifDateTime = now.toISOString().replace(/-/g, ':').substring(0, 19).replace('T', ' ');
          exifObj["0th"][piexif.ImageIFD.DateTime] = exifDateTime;
          exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = exifDateTime;
          exifObj["Exif"][piexif.ExifIFD.DateTimeDigitized] = exifDateTime;
          exifObj["GPS"][piexif.GPSIFD.GPSLatitudeRef] = userLocation.lat >= 0 ? "N" : "S";
          exifObj["GPS"][piexif.GPSIFD.GPSLatitude] = toExifRational(userLocation.lat);
          exifObj["GPS"][piexif.GPSIFD.GPSLongitudeRef] = userLocation.lng >= 0 ? "E" : "W";
          exifObj["GPS"][piexif.GPSIFD.GPSLongitude] = toExifRational(userLocation.lng);
          dataURL = piexif.insert(piexif.dump(exifObj), dataURL);
        } catch (e) {
          console.error("Gagal tambah EXIF:", e);
        }
      }

      // === TAMPILKAN HASIL ===
      capturedImageUrl = dataURL;
      photoPreview.src = capturedImageUrl;
      photoPreview.style.display = 'block';

      // Tampilkan tombol aksi
      downloadBtn.style.display = 'inline-block';
      retakeBtn.style.display = 'inline-block';
      sendBtn.style.display = 'inline-block';
      captureBtn.style.display = 'none';
      switchBtn.disabled = true;
      statusEl.textContent = "Foto siap diunduh!";

      // Pastikan event listener tidak double
      sendBtn.removeEventListener('click', submitToGoogle); // hindari duplikat
      sendBtn.addEventListener('click', submitToGoogle);
    });
    
    // === HANYA UNDUH (1x klik) ===
    downloadBtn.addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = capturedImageUrl;
      a.download = `absensi-${userIdInput.value}-${Date.now()}.jpg`;
      a.click();
    });

    // === Ambil Ulang ===
    retakeBtn.addEventListener('click', () => {
      photoPreview.style.display = 'none';
      downloadBtn.style.display = 'none';
      sendBtn.style.display = 'none';
      retakeBtn.style.display = 'none';
      captureBtn.style.display = 'inline-block';
      switchBtn.disabled = false;
      statusEl.textContent = "Siap ambil foto lagi";
      statuSend.textContent = "";
    });

    // === Mulai Aplikasi ===
    startAppBtn.addEventListener('click', async () => {
      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("Harap masukkan ID Karyawan!");
        return;
      }

      login();
      
    });

    async function absen() {

        const idInput = document.getElementById('userIdInput');
       
        const params = new URLSearchParams();
        params.append('id', idInput.value);
        params.append('lat', userLocation ? userLocation.lat : '');
        params.append('lng', userLocation ? userLocation.lng : '');
        params.append('date', timestampSet);

        sendBtn.disabled = true;
        statuSend.textContent = 'Mengirim data...';

        const id = idInput.value.trim();
        if (!id) {
          sendBtn.disabled = false;
          statuSend.textContent = 'ID Karyawan kosong!';
          return;
        }

        try {
          statuSend.textContent = 'Mengirim data...';
          const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: params
          });

          const text = await response.text();
          
          if (text === 'success') {
              sendBtn.disabled = false;
              statuSend.textContent = `‚úÖ Absen berhasil-ID: ${id}`;

              setTimeout(() => {
                 // === 2. UPLOAD FOTO KE GOOGLE DRIVE ===
                statuSend.textContent = 'Mengupload foto...';
                const photoUrl = uploadPhotoToDrive(idInput.value, capturedImageUrl);
              }, 1000);
             
          } else {
              sendBtn.disabled = false;
              statuSend.textContent =  `‚ùå Gagal: ${text.replace('error: ', '')}`;
          }
        } catch (err) {
          sendBtn.disabled = false;
          statuSend.textContent = '‚ùå Gagal mengirim data.'+err;
          console.error(err);
        }

        sendBtn.disabled = false;

        
      }

    // === Mulai Aplikasi ===
    sendBtn.addEventListener('click', async () => {

      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("Harap masukkan ID Karyawan!");
        return;
      }

      await absen();
      
    });

    let currentHistoriPage = 1;
    let totalHistoriPages = 1;
    // Isi dropdown tahun otomatis (2020‚Äì2030)
    function populateYears() {
      const yearSelect = document.getElementById('filterTahun');
      const currentYear = new Date().getFullYear();
      
      // Isi opsi tahun (2020‚Äì2030)
      for (let year = currentYear + 1; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      
      // Set default ke tahun sekarang
      yearSelect.value = currentYear;
    }

    document.addEventListener('DOMContentLoaded', function() {
      populateYears();
      
      // Set bulan default ke bulan sekarang
      const currentMonth = new Date().getMonth() + 1; // getMonth() = 0‚Äì11
      document.getElementById('filterBulan').value = currentMonth;
    });

    // Fungsi load histori dengan filter
    async function loadHistori(page = 1) {

        const id = document.getElementById('userIdInput').value.trim();
        if (!id) {
          alert("Harap masukkan ID Karyawan!");
          return;
        }

        const bulan = document.getElementById('filterBulan').value;
        const tahun = document.getElementById('filterTahun').value;

        const loading = document.getElementById('loading');
        const table = document.getElementById('historiTable');
        const paginationNav = document.getElementById('paginationNav');
        const noData = document.getElementById('noData');
        const tbody = document.getElementById('historiBody');

        loading.classList.remove('d-none'); 
        table.style.display = 'none';
        paginationNav.style.display = 'none';
        noData.classList.add('d-none');

        try {
          const params = new URLSearchParams({
            action: 'getDailyReport',
            id: id,
            bulan: bulan,
            tahun: tahun, // <-- tambahkan tahun
            page: page
          });

          const url = `${APPS_SCRIPT_URL}?${params.toString()}`;
          const response = await fetch(url);
          const result = await response.json();

          const { data, total } = result;
          const limit = 30;
          totalHistoriPages = Math.ceil(total / limit);
          currentHistoriPage = page;

          tbody.innerHTML = '';
          if (data.length === 0) {
            noData.classList.remove('d-none');
          } else {
            // let setData= transformAbsensiDataWithFilter(data,id,bulan,tahun);
            // console.log('Transformed Data:', setData);

            data.forEach(row => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${row.date}</td>
                <td>${row.clockIn || '-'}</td>
                <td>${row.clockOut || '-'}</td>
              `;
              tbody.appendChild(tr);
            });
            table.style.display = 'table';
          }

          renderPagination();

        } catch (err) {
          console.error('Error:', err);
          noData.innerHTML = '<p class="text-danger">Gagal memuat data.</p>';
          noData.classList.remove('d-none');
        } finally {
          loading.classList.add('d-none');
        }
    }

    // Fungsi render pagination
    function renderPagination() {
      const paginationList = document.getElementById('paginationList');
      paginationList.innerHTML = '';

      if (totalHistoriPages <= 1) {
        document.getElementById('paginationNav').style.display = 'none';
        return;
      }

      document.getElementById('paginationNav').style.display = 'block';

      // Tombol Previous
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentHistoriPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadHistori(${currentHistoriPage - 1}); return false;">&laquo;</a>`;
      paginationList.appendChild(prevLi);

      // Nomor halaman (maks 5 di sekitar halaman aktif)
      let startPage = Math.max(1, currentHistoriPage - 2);
      let endPage = Math.min(totalHistoriPages, startPage + 4);
      if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentHistoriPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="loadHistori(${i}); return false;">${i}</a>`;
        paginationList.appendChild(li);
      }

      // Tombol Next
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentHistoriPage === totalHistoriPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadHistori(${currentHistoriPage + 1}); return false;">&raquo;</a>`;
      paginationList.appendChild(nextLi);
    }


    // Event: saat tab histori aktif, load data pertama kali
    document.getElementById('histori-tab').addEventListener('shown.bs.tab', function () {
        const userId = userIdInput.value.trim();
        if (!userId) {
          alert("Harap masukkan ID Karyawan!");
          return;
        }

        loadHistori(1);
    });

    // Enter di input ID untuk filter
    document.getElementById('userIdInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadHistori(1);
    });

   
    /**
     * Upload foto absen ke Google Drive
     * @param {string} userId - ID karyawan
     * @param {string} dataUrl - URL data gambar (data:image/jpeg;base64,...)
     * @returns {Promise<string>} - URL foto di Google Drive
     */
    async function uploadPhotoToDrive(userId, dataUrl) {
        if (!userId) throw new Error('ID karyawan tidak boleh kosong');
        if (!dataUrl) throw new Error('Foto tidak tersedia');

        // Ambil base64 dari dataURL (hapus prefix "data:image/jpeg;base64,")
        const base64Data = dataUrl.split(',')[1];

        // Format nama file
        const now = new Date();
        const datePart = now.toLocaleDateString('id-ID').replace(/\//g, '-');
        const timePart = now.toLocaleTimeString('id-ID', { hour12: false }).replace(/[:.]/g, '-');
        const fileName = `${userId}_${datePart}_${timePart}.jpg`;

        // Kirim sebagai data teks (bukan FormData!)
        const params = new URLSearchParams();
        params.append('id', userId);
        params.append('fileName', fileName);
        params.append('fileData', base64Data); // ‚Üê base64 string
        params.append('action', 'uploadPhoto');

        const response = await fetch(APPS_SCRIPT_URL.trim(), {
          method: 'POST',
          body: params, // ‚úÖ URLSearchParams, bukan FormData
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        });

        const result = await response.json();
        if (result.status !== 'success') {
          throw new Error(result.message || 'Gagal upload foto');
        }

        return result.url;
      }
  </script>
</body>
</html>
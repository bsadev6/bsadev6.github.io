<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <title>Absensi Karyawan</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 15px;
      background: #f5f5f5;
    }
    #video, #photoPreview {
      width: 100%;
      max-width: 500px;
      height: auto;
      background: #000;
      border-radius: 8px;
      margin: 10px auto;
      transform: scaleX(-1);
    }
    #photoPreview {
      display: none;
      transform: none;
      border: 2px solid #4CAF50;
    }
    #map {
      width: 100%;
      max-width: 500px;
      height: 150px;
      margin: 15px auto;
      border-radius: 8px;
      display: none;
      border: 1px solid #ccc;
    }
    .input-group {
      margin: 15px 0;
    }
    input {
      padding: 12px;
      font-size: 16px;
      width: 80%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .btn {
      margin: 6px;
      padding: 12px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .primary { background: #007AFF; color: white; }
    .success { background: #34C759; color: white; }
    .controls { margin: 15px 0; }
    #status {
      margin: 10px 0;
      color: #555;
      font-size: 14px;
      min-height: 20px;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <h2>üìã Absensi Karyawan</h2>

  <div class="row justify-content-center">
    <div class="col-sm-3">
      <div class="card">
        <div class="card-body">
          <div id="status">Masukkan ID & klik "Login 2"</div>
          <div class="row justify-content-center">
            <div class="col-sm-12">
              <input type="text" id="userIdInput" placeholder="Masukkan ID Karyawan" autocomplete="off">
              <button id="startAppBtn" class="btn primary">‚ñ∂Ô∏è Login</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <br>
  <div class="row justify-content-center">
    <div class="col-sm-3">
        <div class="card">
            <div class="card-body">
    
              <div class="row justify-content-center">
                <div class="col-sm-12">
                  <!-- Tombol mulai -->
                
                  <div id="namaKaryawan" class="info"></div>
                  <div id="locationStatus" class="info"></div>
                  <div id="map"></div>
                  <video 
                    id="video" 
                    autoplay 
                    muted 
                    playsinline 
                    webkit-playsinline
                    style="display:none;"
                  ></video>
                </div>
    
              </div>
              
            </div>
        </div>
    </div>
  </div>

   <br>
  <div class="row justify-content-center">
    <div class="col-sm-3">
        <div class="card">
            <div class="card-body">
                <img id="photoPreview" alt="Foto Absensi">

                <div class="controls">
                  <button id="switchBtn" class="btn btn-primary" style="display:none;">üîÑ Ganti Kamera</button>
                  <button id="captureBtn" class="btn btn-success" style="display:none;">üì∑ Ambil Foto</button>
                  <button id="downloadBtn" class="btn btn-success" style="display:none;">‚¨áÔ∏è Unduh</button>
                  <button id="retakeBtn" class="btn btn-warning" style="display:none;">‚Ü∫ Ambil Ulang</button>
                  <button id="sendBtn" class="btn btn-primary" style="display:none;">üì§ Kirim ke Server</button>
                  <div id="statuSend" ></div>
                </div>
            </div>
        </div>
    </div>
  </div>
  


  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

  <script>
    // === Elemen DOM ===
    const SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSXtPzMDcaFd4wkv58hcPuRJ575PYfn3YP8lgdJW0-plTUkwFzYi9ETU9tAo_izIztDHT376d2oIxRE/pub?output=csv';
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxX1OQPDze6RemtCW9GtHn_AUJVqWy1P3cfD-ctjZyS9gGNXKwrT1kF5N08mTGiQgTC/exec"; // ‚Üê GANTI DI SINI!
    
    const video = document.getElementById('video');
    const photoPreview = document.getElementById('photoPreview');
    const mapEl = document.getElementById('map');
    const userIdInput = document.getElementById('userIdInput');
    const startAppBtn = document.getElementById('startAppBtn');
    const switchBtn = document.getElementById('switchBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const statusEl = document.getElementById('status');
    const sendBtn =  document.getElementById('sendBtn');
    const statuSend = document.getElementById('statuSend');
    const locationStatusEl = document.getElementById('locationStatus');
    const namaKaryawan = document.getElementById('namaKaryawan');
    
    // === Variabel Global ===
    let nama='';
    let timestampSet='';
    let formData = new FormData();
    let stream = null;
    let userLocation = null;
    let capturedImageUrl = null;
    let facingMode = 'user'; // 'user' atau 'environment'
    let map = null;

    async function login() {
      const id = document.getElementById('userIdInput').value.trim();
      
      try {
        const response = await fetch(SHEET_CSV_URL);
        // const response = await fetch(PROXIED_URL);
        const csv = await response.text();
        const lines = csv.split('\n').slice(1); // skip header

        let found = false;
        for (const line of lines) {
          if (!line.trim()) continue;
          const cols = line.split(',');
          const sheetId = cols[0]?.trim(); // kolom pertama = ID
          nama = cols[1]?.trim(); // kolom kedua = Nama
          if (sheetId === id) {
            found = true;
            break;
          }
        }

        if (found) {
         
          alert(`‚úÖ Login berhasil,Selamat Datang: ${id}-${nama}`);
          // Redirect atau lanjut ke halaman absen
          // startAppBtn.style.display = 'none';
          switchBtn.style.display = 'inline-block';
          captureBtn.style.display = 'inline-block';
          namaKaryawan.innerHTML = `<strong>üë§ Karyawan: ${nama} (ID: ${id})</strong>`;
          await requestLocation();
          // await startCamera();

          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d => d.kind === 'videoinput');
          switchBtn.disabled = cams.length <= 1;
        } else {
         
          switchBtn.style.display = 'none';
          captureBtn.style.display = 'none';
          alert('ID tidak ditemukan!');
        }
      } catch (e) {
        // msg.className = 'error';
        // msg.textContent = 'Gagal memuat data. Pastikan sheet dipublikasikan.';
        alert('Gagal memuat data.'+e);
        console.error(e);
      }
    }

    // === Helper: Konversi EXIF ===
    function toExifRational(value) {
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const min = Math.floor((abs - deg) * 60);
      const sec = (abs - deg - min / 60) * 3600;
      return [[deg, 1], [min, 1], [Math.round(sec * 10000), 10000]];
    }

    // === Peta ===
    function initMap(lat, lng) {
      mapEl.style.display = 'block';
      if (map) map.remove();
      map = L.map('map').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      L.marker([lat, lng]).addTo(map).bindPopup('Lokasi Absensi').openPopup();

      startCamera();
    }

    // === Lokasi ===
    async function requestLocation() {
      
      if (!navigator.geolocation) {
        statusEl.textContent = "Geolocation tidak didukung";
        return null;
      }
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000
          });
        });
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        locationStatusEl.style.display='block';
        locationStatusEl.textContent = `‚úÖ Lokasi: ${userLocation.lat}, ${userLocation.lng}`;
        initMap(userLocation.lat, userLocation.lng);
        return userLocation;
      } catch (err) {
        userLocation = null;
        statusEl.textContent = "Lokasi tidak diizinkan";
        mapEl.style.display = 'none';
        return null;
      }
    }

    // === Kamera ===
    async function startCamera() {

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });
        video.srcObject = stream;
        video.style.display = 'block';
        captureBtn.disabled = false;
        statusEl.textContent = `Kamera aktif (${facingMode === 'user' ? 'Depan' : 'Belakang'})`;
      } catch (err) {
        statusEl.textContent = "Gagal akses kamera";
        console.error(err);
      }
    }

    // === Ganti Kamera ===
    switchBtn.addEventListener('click', async () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
      facingMode = facingMode === 'user' ? 'environment' : 'user';
      await startCamera();
    });

    captureBtn.addEventListener('click', async () => {
      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("Harap masukkan ID Karyawan!");
        return;
      }

      if (!userLocation) await requestLocation();

      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      // === GAMBAR VIDEO TANPA MIRROR (FLIP HORIZONTAL) ===
      ctx.save();
      ctx.translate(w, 0);      // Pindahkan origin ke kanan
      ctx.scale(-1, 1);         // Balik sumbu X (mirror horizontal)
      ctx.drawImage(video, 0, 0, w, h); // Gambar video dalam keadaan terbalik ‚Üí hasilnya normal
      ctx.restore();            // Kembalikan transformasi agar teks tidak ikut terbalik

      // === TAMBAHKAN TEKS INFORMASI ===
      const now = new Date();
      const timestamp = now.toLocaleString('id-ID', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });

      timestampSet=timestamp;

      ctx.font = '16px Arial';
      ctx.textBaseline = 'top';

      const timestampText = `Waktu: ${timestamp}`;
      const locText = userLocation ? 
        `Lokasi: ${userLocation.lat}, ${userLocation.lng}` : 
        "Lokasi: Tidak tersedia";
      const idText = `ID: ${userId}-${nama}`;

      // Kirim ke Google Apps Script
     
      // formData.append('id', userId);
      // formData.append('lat', userLocation.lat);
      // formData.append('lng', userLocation.lng);
      // formData.append('date', timestamp);
      // formData.append('time', time);

      const tw = ctx.measureText(timestampText).width;
      const lw = ctx.measureText(locText).width;
      const iw = ctx.measureText(idText).width;
      const boxW = Math.max(tw, lw, iw) + 20;
      const boxH = userLocation ? 75 : 60;

      // Kotak latar belakang transparan
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(10, 10, boxW, boxH);

      // Teks putih di atas kotak
      ctx.fillStyle = 'white';
      ctx.fillText(timestampText, 20, 15);
      ctx.fillText(idText, 20, 35);
      if (userLocation) ctx.fillText(locText, 20, 55);

      // === SIMPAN SEBAGAI JPEG DENGAN EXIF (JIKA ADA LOKASI) ===
      let dataURL = canvas.toDataURL('image/jpeg', 0.92);

      if (piexif && userLocation) {
        try {
          let exifObj = piexif.load(dataURL);
          const exifDateTime = now.toISOString().replace(/-/g, ':').substring(0, 19).replace('T', ' ');
          exifObj["0th"][piexif.ImageIFD.DateTime] = exifDateTime;
          exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = exifDateTime;
          exifObj["Exif"][piexif.ExifIFD.DateTimeDigitized] = exifDateTime;
          exifObj["GPS"][piexif.GPSIFD.GPSLatitudeRef] = userLocation.lat >= 0 ? "N" : "S";
          exifObj["GPS"][piexif.GPSIFD.GPSLatitude] = toExifRational(userLocation.lat);
          exifObj["GPS"][piexif.GPSIFD.GPSLongitudeRef] = userLocation.lng >= 0 ? "E" : "W";
          exifObj["GPS"][piexif.GPSIFD.GPSLongitude] = toExifRational(userLocation.lng);
          dataURL = piexif.insert(piexif.dump(exifObj), dataURL);
        } catch (e) {
          console.error("Gagal tambah EXIF:", e);
        }
      }

      // === TAMPILKAN HASIL ===
      capturedImageUrl = dataURL;
      photoPreview.src = capturedImageUrl;
      photoPreview.style.display = 'block';

      // Tampilkan tombol aksi
      downloadBtn.style.display = 'inline-block';
      retakeBtn.style.display = 'inline-block';
      sendBtn.style.display = 'inline-block';
      captureBtn.style.display = 'none';
      switchBtn.disabled = true;
      statusEl.textContent = "Foto siap diunduh!";

      // Pastikan event listener tidak double
      sendBtn.removeEventListener('click', submitToGoogle); // hindari duplikat
      sendBtn.addEventListener('click', submitToGoogle);
    });
    
    // === HANYA UNDUH (1x klik) ===
    downloadBtn.addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = capturedImageUrl;
      a.download = `absensi-${userIdInput.value}-${Date.now()}.jpg`;
      a.click();
    });

    // === Ambil Ulang ===
    retakeBtn.addEventListener('click', () => {
      photoPreview.style.display = 'none';
      downloadBtn.style.display = 'none';
      sendBtn.style.display = 'none';
      retakeBtn.style.display = 'none';
      captureBtn.style.display = 'inline-block';
      switchBtn.disabled = false;
      statusEl.textContent = "Siap ambil foto lagi";
      statuSend.textContent = "";
    });

    // === Mulai Aplikasi ===
    startAppBtn.addEventListener('click', async () => {
      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("Harap masukkan ID Karyawan!");
        return;
      }

      login();
      
    });

    async function absen() {

        const idInput = document.getElementById('userIdInput');
        let val ={
          id: idInput.value,
          lat: userLocation ? userLocation.lat : '',
          lng: userLocation ? userLocation.lng : '',
          date: timestampSet,
        };

        sendBtn.disabled = true;
        statuSend.textContent = 'Mengirim data...';

        const id = idInput.value.trim();
        if (!id) {
          sendBtn.disabled = false;
          statuSend.textContent = 'ID Karyawan kosong!';
          return;
        }

        try {
          statuSend.textContent = 'Mengirim data...';
          const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: val
          });

          const text = await response.text();
          
          if (text === 'success') {
              sendBtn.disabled = false;
              statuSend.textContent = '‚úÖ Absen berhasil!<br>ID: ${id}';
          } else {
              sendBtn.disabled = false;
              statuSend.textContent =  `‚ùå Gagal: ${text.replace('error: ', '')}`;
          }
        } catch (err) {
          sendBtn.disabled = false;
          statuSend.textContent = '‚ùå Gagal mengirim data.'+err;
          alert('error:'+err);
          console.error(err);
        }

        sendBtn.disabled = false;

        
      }

    // === Mulai Aplikasi ===
    sendBtn.addEventListener('click', async () => {

      const userId = userIdInput.value.trim();
      if (!userId) {
        alert("Harap masukkan ID Karyawan!");
        return;
      }

      await absen();
      
    });
  </script>
</body>
</html>